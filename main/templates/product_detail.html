{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ product.name }} - French Football Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-light min-vh-100 py-5">
  <div class="container">
    <!-- Back link -->
    <div class="mb-4">
      <a href="{% url 'main:show_main' %}" class="text-secondary text-decoration-none">
        ← Back to products
      </a>
    </div>

    <!-- Product Detail Card -->
    <div class="card shadow-sm p-4">
      <div class="row g-4">
        <!-- Product Image -->
        <div class="col-12 col-md-6 text-center">
          {% if product.thumbnail %}
            <img src="{{ product.thumbnail }}" 
                 alt="{{ product.name }}" 
                 class="img-fluid rounded" 
                 style="max-height: 500px; object-fit: cover;">
          {% else %}
            <div class="bg-secondary rounded" style="width:100%; height:400px;"></div>
          {% endif %}
        </div>

        <!-- Product Info -->
        <div class="col-12 col-md-6 d-flex flex-column justify-content-between">
          <div>
            <h1 class="h4 fw-bold mb-2">{{ product.name }}</h1>

            <!-- Badges -->
            <div class="mb-3">
                <span class="badge bg-light text-dark border border-dark fs-6 me-1">{{ product.get_category_display }}</span>
                <span class="badge bg-light text-dark border border-dark fs-6 me-1">{{ product.brand }}</span>
              {% if product.is_featured %}
                <span class="badge bg-warning text-dark me-1">Featured</span>
              {% endif %}
              {% if product.is_item_hot %}
                <span class="badge bg-danger me-1">Hot</span>
              {% endif %}
            </div>

            <!-- Views / Date -->
            <div class="text-muted small mb-3">
                Released: {{ product.release_year }} • {{ product.item_views }} views
            </div>

            <!-- Price -->
            <h2 class="h3 fw-bold text-dark mb-4">{{ product.price }} €</h2>

            <!-- Description -->
            <p class="text-secondary mb-4">{{ product.description }}</p>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-darkblue flex-grow-1 rounded-pill">
                Add to Cart
            </button>

            <button id="favourite-btn"
                    type="button"
                    class="btn {% if user in product.favourites.all %}btn-darkblue{% else %}btn-outline-darkblue{% endif %} flex-grow-1 rounded-pill"
                    data-product-id="{{ product.id }}">
                <i id="favourite-icon" class="bi {% if user in product.favourites.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i> Favourite
            </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("favourite-btn");
    const icon = document.getElementById("favourite-icon");
    const productId = btn.dataset.productId;

    btn.addEventListener("click", function () {
        fetch(`/product/${productId}/toggle_favourites/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
                "Accept": "application/json"
            }
            })
        .then(response => response.json())
        .then(data => {
            if (data.is_favourite) {
                btn.classList.remove("btn-outline-dark");
                btn.classList.add("btn-darkblue");
                icon.classList.remove("bi-heart");
                icon.classList.add("bi-heart-fill");
            } else {
                btn.classList.remove("btn-darkblue");
                btn.classList.add("btn-outline-dark");
                icon.classList.remove("bi-heart-fill");
                icon.classList.add("bi-heart");
            }
        });
    });

    // Fonction utilitaire pour récupérer le CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}